# ----------------------------------------------------------------------------------
# I. CMake åŸºç¡€é…ç½®ä¸ç¯å¢ƒæ£€æŸ¥
# ----------------------------------------------------------------------------------
cmake_minimum_required(VERSION 3.22)
project(QtWidgetsApp LANGUAGES CXX)

# è®¾ç½® C++ æ ‡å‡†å’Œç¼–è¯‘æ¨¡å¼
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# é»˜è®¤æ„å»ºç±»å‹è®¾ç½®ä¸º Debug
if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Debug CACHE STRING "Choose the type of build: Debug or Release." FORCE)
endif()

# æ£€æŸ¥ç¼–è¯‘å™¨æ˜¯å¦ä¸º Clang
if (NOT CMAKE_CXX_COMPILER_ID MATCHES "Clang")
    message(FATAL_ERROR "æœ¬é¡¹ç›®åŸºäº LLVM ç¯å¢ƒï¼Œè¯·ç¡®ä¿ä½¿ç”¨ Clang ç¼–è¯‘å™¨ã€‚")
endif()

# ----------------------------------------------------------------------------------
# II. è·¯å¾„å®šä¹‰ä¸ Qt è‡ªåŠ¨åŒ–è®¾ç½®
# ----------------------------------------------------------------------------------
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_SKIP_AUTOMOC_RUN_IN_CMAKE TRUE)

# æºç /å¤´æ–‡ä»¶/UI/èµ„æºç›®å½•
set(SOURCE_DIR "${CMAKE_SOURCE_DIR}/src")
set(INCLUDE_DIR "${CMAKE_SOURCE_DIR}/include")
set(FORMS_DIR "${CMAKE_SOURCE_DIR}/forms")
set(RES_DIR "${CMAKE_SOURCE_DIR}/res")

# ----------------------------------------------------------------------------------
# III. Qt æ¨¡å—åŒ–å¼€å…³æ§åˆ¶
# ----------------------------------------------------------------------------------
message(STATUS "--------------------------------------------------------")
message(STATUS "Qt æ¨¡å—å¼€å…³é…ç½®:")

option(USE_QT_CORE      "å¯ç”¨ Qt6::Core æ¨¡å—"        ON)
option(USE_QT_GUI       "å¯ç”¨ Qt6::Gui æ¨¡å—"         ON)
option(USE_QT_WIDGETS   "å¯ç”¨ Qt6::Widgets æ¨¡å—"     ON)
option(USE_QT_NETWORK   "å¯ç”¨ Qt6::Network æ¨¡å—"     ON)
option(USE_QT_SQL       "å¯ç”¨ Qt6::Sql æ¨¡å—"         OFF)

set(QT_COMPONENTS_TO_FIND "")
set(QT_LIBRARIES_TO_LINK  "")

macro(add_qt_component name opt)
    if(${opt})
        list(APPEND QT_COMPONENTS_TO_FIND ${name})
        list(APPEND QT_LIBRARIES_TO_LINK Qt6::${name})
    endif()
    message(STATUS "  - ${name}: ${${opt}}")
endmacro()

add_qt_component(Core      USE_QT_CORE)
add_qt_component(Gui       USE_QT_GUI)
add_qt_component(Widgets   USE_QT_WIDGETS)
add_qt_component(Network   USE_QT_NETWORK)
add_qt_component(Sql       USE_QT_SQL)

message(STATUS "--------------------------------------------------------")

# ----------------------------------------------------------------------------------
# IV. æŸ¥æ‰¾ Qt ç»„ä»¶
# ----------------------------------------------------------------------------------
if(QT_COMPONENTS_TO_FIND)
    find_package(Qt6 COMPONENTS ${QT_COMPONENTS_TO_FIND} REQUIRED)
else()
    message(FATAL_ERROR "æœªå¯ç”¨ä»»ä½• Qt ç»„ä»¶ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚")
endif()

qt_standard_project_setup()

# ----------------------------------------------------------------------------------
# V. æºæ–‡ä»¶å’Œèµ„æºå¤„ç†
# ----------------------------------------------------------------------------------
# æ”¶é›† CPP/H æºæ–‡ä»¶
file(GLOB APP_SOURCES
    "${SOURCE_DIR}/*.cpp"
    "${INCLUDE_DIR}/*.h"
)

# æ”¶é›† UI æ–‡ä»¶ï¼ˆç»å¯¹è·¯å¾„ï¼‰
file(GLOB UI_FORMS "${FORMS_DIR}/*.ui")

# æ³¨å†Œ Qt èµ„æºæ–‡ä»¶
qt_add_resources(RESOURCES_QRC_OUTPUT ${RES_DIR}/resources.qrc)
list(APPEND APP_SOURCES ${RESOURCES_QRC_OUTPUT})

# ----------------------------------------------------------------------------------
# VI. åˆ›å»ºç›®æ ‡å’Œé“¾æ¥è®¾ç½®
# ----------------------------------------------------------------------------------
set(TARGET_NAME QtWidgetsApp)

qt_add_executable(${TARGET_NAME} 
    ${APP_SOURCES}
    ${UI_FORMS}  # UI æ–‡ä»¶åˆ—è¡¨ï¼Œå¿…é¡»æ˜¯ç»å¯¹è·¯å¾„
)

# æ˜ç¡® AUTOUIC æœç´¢è·¯å¾„
set_property(TARGET ${TARGET_NAME} PROPERTY AUTOUIC_SEARCH_PATHS ${FORMS_DIR})

# åŒ…å«å¤´æ–‡ä»¶ç›®å½•
target_include_directories(${TARGET_NAME} PRIVATE
    ${INCLUDE_DIR}
)

# é“¾æ¥ Qt æ¨¡å—
target_link_libraries(${TARGET_NAME} PRIVATE 
    ${QT_LIBRARIES_TO_LINK}
)

# ----------------------------------------------------------------------------------
# VII. é“¾æ¥å™¨å’Œç¼–è¯‘é€‰é¡¹ï¼ˆWindows + Clang/UCRTï¼‰
# ----------------------------------------------------------------------------------
if(WIN32)
    if("${CMAKE_BUILD_TYPE}" STREQUAL "Debug")
        set_target_properties(${TARGET_NAME} PROPERTIES WIN32_EXECUTABLE FALSE)
        target_link_options(${TARGET_NAME} PRIVATE
            $<$<PLATFORM_ID:Windows>:-Wl,--subsystem,console>
        )
        message(STATUS "Debug æ¨¡å¼: å·²å¯ç”¨ CONSOLE å­ç³»ç»Ÿé“¾æ¥ (-Wl,--subsystem,console)")
    else()
        set_target_properties(${TARGET_NAME} PROPERTIES WIN32_EXECUTABLE TRUE)
        message(STATUS "Release æ¨¡å¼: å·²å¯ç”¨ WIN32 å­ç³»ç»Ÿé“¾æ¥")
    endif()
endif()

# -------------------- ç¼–è¯‘è­¦å‘Šé€‰é¡¹ --------------------
add_compile_options(
    -Wall -Wextra
    -Wno-unused-parameter
    -Wno-non-virtual-dtor
    -Wno-unused-variable
    -Wno-unused-private-field
)

# ----------------------------------------------------------------------------------
# VIII. è‡ªå®šä¹‰æ„å»ºç›®æ ‡ (æ¸…ç†)
# ----------------------------------------------------------------------------------
function(add_clean_targets target_name)
    if(CMAKE_GENERATOR STREQUAL "Ninja")
        add_custom_target(clean-${target_name}
            COMMAND ${CMAKE_COMMAND} --build ${CMAKE_BINARY_DIR} --target clean
            COMMENT "Cleaning all intermediate files for ${target_name}..."
        )
    endif()
endfunction()

add_clean_targets(${TARGET_NAME})

# ----------------------------------------------------------------------------------
# IX. ç¼–è¯‘ä¿¡æ¯æ€»ç»“
# ----------------------------------------------------------------------------------
message(STATUS "==========================================")
message(STATUS "ğŸ¯ QtWidgetsApp CMake Configuration Summary")
message(STATUS "ç¼–è¯‘å™¨ ID: ${CMAKE_CXX_COMPILER_ID}")
message(STATUS "C++ æ ‡å‡†: C++${CMAKE_CXX_STANDARD}")
message(STATUS "æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}")
message(STATUS "Target: ${TARGET_NAME}")
message(STATUS "UI æ–‡ä»¶ç›®å½•: ${FORMS_DIR}")
message(STATUS "==========================================")
